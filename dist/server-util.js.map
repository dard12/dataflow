{"version":3,"file":"server-util.js","sourceRoot":"/","sources":["server-util.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AACA,kDAAuB;AAoBvB,SAAsB,OAAO,CAC3B,OAAqB,EACrB,UAAkB,EAClB,OAAmD;;;;;;;oBAE7C,IAAI,GAAG,gBAAC,CAAC,QAAQ,CAAC,OAAO,aAAP,OAAO,uBAAP,OAAO,CAAE,IAAI,CAAC,IAAI,CAAC,CAAC;oBACtC,YAAY,GAAG,IAAI,GAAG,CAAC,CAAC;oBACxB,QAAQ,GAAG,gBAAC,CAAC,QAAQ,CAAC,OAAO,aAAP,OAAO,uBAAP,OAAO,CAAE,QAAQ,CAAC,IAAI,CAAC,CAAC;oBAEvC,qBAAM,OAAO;6BACvB,KAAK,EAAE;6BACP,KAAK,CAAC,QAAQ,CAAC;6BACf,MAAM,CAAC,QAAQ,GAAG,YAAY,CAAC,EAAA;;oBAH5B,IAAI,GAAG,SAGqB;oBAE5B,YAAY,GAAG,UAAO,KAAa;;;;;oCAChC,KAAA,CAAA,KAAA,gBAAC,CAAA,CAAC,IAAI,CAAA;oCACX,qBAAM,OAAO;6CACV,KAAK,EAAE;6CACP,KAAK,CAAC,CAAC,CAAC;6CACR,MAAM,CAAC,QAAQ,GAAG,CAAC,YAAY,GAAG,KAAK,CAAC,CAAC,EAAA;wCAJ9C,sBAAO,cACL,SAG4C,EAC7C,EAAC;;;yBACH,CAAC;oBAEE,IAAI,GAAG,IAAI,CAAC;oBAEZ,qBAAM,YAAY,CAAC,CAAC,CAAC,EAAA;;yBAArB,SAAqB,EAArB,wBAAqB;oBACvB,IAAI,GAAG,gBAAC,CAAC,KAAK,CAAC,IAAI,GAAG,CAAC,EAAE,IAAI,GAAG,CAAC,CAAC,CAAC;;wBAC1B,qBAAM,YAAY,CAAC,CAAC,CAAC,EAAA;;yBAArB,SAAqB,EAArB,wBAAqB;oBAC9B,IAAI,GAAG,gBAAC,CAAC,KAAK,CAAC,IAAI,GAAG,CAAC,EAAE,IAAI,GAAG,CAAC,CAAC,CAAC;;wBAC1B,qBAAM,YAAY,CAAC,CAAC,CAAC,EAAA;;yBAArB,SAAqB,EAArB,wBAAqB;oBAC9B,IAAI,GAAG,gBAAC,CAAC,KAAK,CAAC,IAAI,GAAG,CAAC,EAAE,IAAI,GAAG,CAAC,CAAC,CAAC;;wBAC1B,qBAAM,YAAY,CAAC,CAAC,CAAC,EAAA;;yBAArB,SAAqB,EAArB,wBAAqB;oBAC9B,IAAI,GAAG,gBAAC,CAAC,KAAK,CAAC,IAAI,GAAG,CAAC,EAAE,IAAI,GAAG,CAAC,CAAC,CAAC;;wBAC1B,qBAAM,YAAY,CAAC,CAAC,CAAC,EAAA;;oBAAzB,IAAI,SAAqB,EAAE;wBAChC,IAAI,GAAG,gBAAC,CAAC,KAAK,CAAC,IAAI,GAAG,CAAC,EAAE,IAAI,GAAG,CAAC,CAAC,CAAC;qBACpC;;yBAED,sBAAO,EAAE,IAAI,MAAA,EAAE,IAAI,MAAA,EAAE,IAAI,MAAA,EAAE,UAAU,YAAA,EAAE,EAAC;;;;CACzC;AAtCD,0BAsCC;AAED,SAAgB,UAAU,CACxB,GAAa,EACb,MAAsD;IAEtD,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;AAC/B,CAAC;AALD,gCAKC;AAED,SAAgB,SAAS,CAAC,GAAa,EAAE,IAAU;IAAV,qBAAA,EAAA,UAAU;IACjD,GAAG,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC,IAAI,EAAE,CAAC;AAC1B,CAAC;AAFD,8BAEC;AAED,SAAgB,WAAW,CAAC,GAAa,EAAE,IAAU;IACnD,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;AAC7B,CAAC;AAFD,kCAEC","sourcesContent":["import { QueryBuilder } from 'knex';\nimport _ from 'lodash';\nimport { Response } from 'express';\n\ninterface QueryOptions {\n  page?: number;\n  pageSize?: number;\n}\n\nexport interface GetQuery<Doc, AdditionalFields = {}> {\n  query: Partial<Doc> & QueryOptions & AdditionalFields;\n  user?: any;\n}\n\ninterface UpdateResponse {\n  docs: any[];\n  collection: string;\n  page?: number;\n  next?: number[] | null;\n}\n\nexport async function execute(\n  pgQuery: QueryBuilder,\n  collection: string,\n  options?: QueryOptions & { [ignored: string]: any },\n): Promise<UpdateResponse> {\n  const page = _.toNumber(options?.page) || 1;\n  const databasePage = page - 1;\n  const pageSize = _.toNumber(options?.pageSize) || 5;\n\n  const docs = await pgQuery\n    .clone()\n    .limit(pageSize)\n    .offset(pageSize * databasePage);\n\n  const hasPageAhead = async (ahead: number) => {\n    return _.size(\n      await pgQuery\n        .clone()\n        .limit(1)\n        .offset(pageSize * (databasePage + ahead)),\n    );\n  };\n\n  let next = null;\n\n  if (await hasPageAhead(5)) {\n    next = _.range(page + 1, page + 6);\n  } else if (await hasPageAhead(4)) {\n    next = _.range(page + 1, page + 5);\n  } else if (await hasPageAhead(3)) {\n    next = _.range(page + 1, page + 4);\n  } else if (await hasPageAhead(2)) {\n    next = _.range(page + 1, page + 3);\n  } else if (await hasPageAhead(1)) {\n    next = _.range(page + 1, page + 2);\n  }\n\n  return { docs, page, next, collection };\n}\n\nexport function sendUpdate(\n  res: Response,\n  update: UpdateResponse | { updates: UpdateResponse[] },\n) {\n  res.status(200).send(update);\n}\n\nexport function sendError(res: Response, code = 400) {\n  res.status(code).send();\n}\n\nexport function sendSuccess(res: Response, data?: any) {\n  res.status(200).send(data);\n}\n"]}